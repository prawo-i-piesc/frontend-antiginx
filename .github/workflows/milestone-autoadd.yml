name: Milestone Management
run-name: >-
    ${{ 
        github.event_name == 'pull_request' 
        && format('Manage Milestone for PR #{0} -> {1}', github.event.number, github.event.pull_request.title) 
    }}

on:
    pull_request:
        types: [opened, reopened]

permissions:
    statuses: read
    contents: read
    issues: read
    pull-requests: write

jobs:
    milestone-management:
        name: Milestone Management - autoadd

        runs-on: ubuntu-latest

        steps:
        - name: Set Milestone
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            GH_REPO: ${{ github.repository }}
            PR_URL: ${{ github.event.pull_request.html_url }}
            BRANCH: ${{ github.head_ref }}
          run: |
            # 1. Get Issue ID from branch name (e.g. feat/123-my-feature)
            ISSUE_ID=$(echo "$BRANCH" | grep -oE '(/|^)[0-9]+' | head -n 1 | tr -d '/')

            # 2. Get Milestone name from Issue
            MILESTONE=$(gh issue view "$ISSUE_ID" --json milestone --jq '.milestone.title // empty' 2>/dev/null || true)
            
            # 3. If Milestone exists, set it in PR
            if [ -n "$ISSUE_ID" ] && [ -n "$MILESTONE" ]; then
                gh pr edit "$PR_URL" --milestone "$MILESTONE"
                echo "Set milestone '$MILESTONE' from issue #$ISSUE_ID to PR"
            else
                echo "No milestone found for issue #$ISSUE_ID"
            fi